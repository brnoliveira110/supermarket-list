version: '3.8'

services:
  # --- BACKEND API (GO) ---
  api:
    # 'context' é o caminho para o Dockerfile e código do backend
    build:
      context: ./apps/api
      dockerfile: Dockerfile.dev
    ports:
      - "8080:8080"
    volumes:
      # Monta o código local no container para hot-reload
      - ./apps/api:/app
    depends_on:
      - db # Garante que o banco inicie antes da API
    environment:
      # Passe a URL do banco para sua app Go
      - DATABASE_URL=postgres://user:password@db:5432/supermarket?sslmode=disable
    networks:
      - app-network

  # --- FRONTEND (NEXT.JS) ---
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    volumes:
      # Monta o código local no container
      - ./apps/web:/app
      # Use volumes nomeados para node_modules e .next para preservar
      # os arquivos gerados durante o build da imagem e evitar
      # que o bind-mount do host sobrescreva essas pastas.
      - web_node_modules:/app/node_modules
      - web_next:/app/.next
    environment:
      # Diz ao Next.js onde encontrar a API
      - NEXT_PUBLIC_API_URL=http://localhost:8080/api
      - CI=true
    depends_on:
      - api
    networks:
      - app-network

  # --- BANCO DE DADOS (POSTGRESQL) ---
  db:
    image: postgres:15-alpine
    ports:
      - "5432:5432" # Expõe a porta do Postgres para o seu PC (opcional)
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=supermarket
    volumes:
      # Persiste os dados do banco na sua máquina local
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app-network

# Define a rede compartilhada
networks:
  app-network:
    driver: bridge

# Define o volume persistente
volumes:
  postgres_data:
    driver: local
  web_node_modules:
    driver: local
  web_next:
    driver: local